<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASRæµå¼è¯†åˆ«æµ‹è¯• - demo.zjuicsr.cn</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-gray-900 via-purple-900 to-gray-900 text-white min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <h1 class="text-5xl font-bold mb-8 text-center bg-gradient-to-r from-cyan-400 via-purple-400 to-pink-400 bg-clip-text text-transparent">
            ğŸ¤ ASRæµå¼è¯­éŸ³è¯†åˆ«æµ‹è¯•
        </h1>
        
        <!-- æœåŠ¡å™¨é…ç½® -->
        <div class="bg-white bg-opacity-10 backdrop-blur-lg rounded-2xl p-6 mb-6 border border-white border-opacity-20">
            <h2 class="text-2xl font-bold mb-4 flex items-center">
                <span class="mr-2">âš™ï¸</span> æœåŠ¡å™¨é…ç½®
            </h2>
            <div class="space-y-3">
                <div class="flex items-center justify-between">
                    <label class="text-gray-300">WebSocketåœ°å€:</label>
                    <input 
                        id="wsUrl" 
                        type="text" 
                        value="ws://demo.zjuicsr.cn:3780/ws/asr"
                        class="px-4 py-2 bg-gray-800 rounded-lg border border-gray-600 focus:border-cyan-400 focus:outline-none flex-1 ml-4"
                    >
                </div>
                <p class="text-sm text-red-400">âš ï¸ è¯·ä½¿ç”¨ HTTP è®¿é—®æ­¤é¡µé¢ (http://demo.zjuicsr.cn:3780/)ï¼Œæˆ–é…ç½®SSLè¯ä¹¦åä½¿ç”¨ wss://</p>
            </div>
        </div>
        
        <!-- è¿æ¥çŠ¶æ€ -->
        <div class="bg-white bg-opacity-10 backdrop-blur-lg rounded-2xl p-6 mb-6 border border-white border-opacity-20">
            <h2 class="text-2xl font-bold mb-4 flex items-center">
                <span class="mr-2">ğŸ“¡</span> è¿æ¥çŠ¶æ€
            </h2>
            <div id="status" class="text-xl font-semibold">
                <span class="text-yellow-400">âšª æœªè¿æ¥</span>
            </div>
            <div id="sessionInfo" class="text-sm text-gray-400 mt-2"></div>
        </div>
        
        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="bg-white bg-opacity-10 backdrop-blur-lg rounded-2xl p-6 mb-6 border border-white border-opacity-20">
            <h2 class="text-2xl font-bold mb-4 flex items-center">
                <span class="mr-2">ğŸ®</span> æ§åˆ¶é¢æ¿
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <button 
                    id="connectBtn" 
                    onclick="connect()"
                    class="px-6 py-4 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 rounded-xl font-bold text-lg transition-all transform hover:scale-105 shadow-lg"
                >
                    ğŸ”Œ è¿æ¥æœåŠ¡
                </button>
                <button 
                    id="startBtn" 
                    onclick="startRecording()"
                    class="px-6 py-4 bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 rounded-xl font-bold text-lg transition-all transform hover:scale-105 shadow-lg"
                    disabled
                >
                    ğŸ¤ å¼€å§‹å½•éŸ³
                </button>
                <button 
                    id="stopBtn" 
                    onclick="stopRecording()"
                    class="px-6 py-4 bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 rounded-xl font-bold text-lg transition-all transform hover:scale-105 shadow-lg"
                    disabled
                >
                    â¹ï¸ åœæ­¢å½•éŸ³
                </button>
            </div>
        </div>
        
        <!-- éŸ³é¢‘å¯è§†åŒ– -->
        <div class="bg-white bg-opacity-10 backdrop-blur-lg rounded-2xl p-6 mb-6 border border-white border-opacity-20">
            <h2 class="text-2xl font-bold mb-4 flex items-center">
                <span class="mr-2">ğŸ“Š</span> éŸ³é¢‘æ³¢å½¢
            </h2>
            <canvas id="waveform" class="w-full h-24 bg-gray-900 rounded-lg"></canvas>
        </div>
        
        <!-- å®æ—¶è¯†åˆ«ç»“æœ -->
        <div class="bg-white bg-opacity-10 backdrop-blur-lg rounded-2xl p-6 mb-6 border border-white border-opacity-20">
            <h2 class="text-2xl font-bold mb-4 flex items-center">
                <span class="mr-2">ğŸ“</span> å®æ—¶è¯†åˆ«ç»“æœ
            </h2>
            <div id="result" class="text-2xl min-h-32 bg-gray-900 bg-opacity-50 rounded-xl p-6 border-2 border-cyan-500 border-opacity-30">
                <span class="text-gray-500">ç­‰å¾…è¯†åˆ«...</span>
            </div>
        </div>
        
        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div class="bg-white bg-opacity-10 backdrop-blur-lg rounded-2xl p-6 mb-6 border border-white border-opacity-20">
            <h2 class="text-2xl font-bold mb-4 flex items-center">
                <span class="mr-2">ğŸ“ˆ</span> ç»Ÿè®¡ä¿¡æ¯
            </h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                <div class="bg-gray-900 bg-opacity-50 rounded-lg p-4">
                    <div class="text-3xl font-bold text-cyan-400" id="chunkCount">0</div>
                    <div class="text-sm text-gray-400">éŸ³é¢‘å—æ•°</div>
                </div>
                <div class="bg-gray-900 bg-opacity-50 rounded-lg p-4">
                    <div class="text-3xl font-bold text-green-400" id="wordCount">0</div>
                    <div class="text-sm text-gray-400">è¯†åˆ«å­—æ•°</div>
                </div>
                <div class="bg-gray-900 bg-opacity-50 rounded-lg p-4">
                    <div class="text-3xl font-bold text-purple-400" id="duration">0s</div>
                    <div class="text-sm text-gray-400">å½•éŸ³æ—¶é•¿</div>
                </div>
                <div class="bg-gray-900 bg-opacity-50 rounded-lg p-4">
                    <div class="text-3xl font-bold text-yellow-400" id="latency">0ms</div>
                    <div class="text-sm text-gray-400">å¹³å‡å»¶è¿Ÿ</div>
                </div>
            </div>
        </div>
        
        <!-- æ—¥å¿— -->
        <div class="bg-white bg-opacity-10 backdrop-blur-lg rounded-2xl p-6 border border-white border-opacity-20">
            <h2 class="text-2xl font-bold mb-4 flex items-center">
                <span class="mr-2">ğŸ“‹</span> ç³»ç»Ÿæ—¥å¿—
            </h2>
            <div id="log" class="text-sm font-mono bg-gray-900 bg-opacity-50 rounded-xl p-4 max-h-64 overflow-y-auto">
                <div class="text-gray-500">ç³»ç»Ÿå°±ç»ª âœ“</div>
            </div>
        </div>
    </div>

    <script>
        let ws = null;
        let audioContext = null;
        let processor = null;
        let isRecording = false;
        let startTime = null;
        let chunksSent = 0;
        let totalLatency = 0;
        let latencyCount = 0;

        const statusDiv = document.getElementById('status');
        const resultDiv = document.getElementById('result');
        const logDiv = document.getElementById('log');
        const sessionInfo = document.getElementById('sessionInfo');
        const connectBtn = document.getElementById('connectBtn');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const wsUrlInput = document.getElementById('wsUrl');

        // æ³¢å½¢å¯è§†åŒ–
        const canvas = document.getElementById('waveform');
        const canvasCtx = canvas.getContext('2d');
        canvas.width = canvas.offsetWidth;
        canvas.height = canvas.offsetHeight;

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: 'text-blue-400',
                success: 'text-green-400',
                error: 'text-red-400',
                warning: 'text-yellow-400'
            };
            const icons = {
                info: 'â„¹ï¸',
                success: 'âœ…',
                error: 'âŒ',
                warning: 'âš ï¸'
            };
            const entry = document.createElement('div');
            entry.className = `${colors[type] || colors.info} mb-1`;
            entry.textContent = `[${timestamp}] ${icons[type]} ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateStats() {
            document.getElementById('chunkCount').textContent = chunksSent;
            if (startTime) {
                const duration = Math.floor((Date.now() - startTime) / 1000);
                document.getElementById('duration').textContent = duration + 's';
            }
            if (latencyCount > 0) {
                const avgLatency = Math.floor(totalLatency / latencyCount);
                document.getElementById('latency').textContent = avgLatency + 'ms';
            }
        }

        function drawWaveform(dataArray) {
            canvasCtx.fillStyle = 'rgb(17, 24, 39)';
            canvasCtx.fillRect(0, 0, canvas.width, canvas.height);
            
            canvasCtx.lineWidth = 2;
            canvasCtx.strokeStyle = 'rgb(34, 211, 238)';
            canvasCtx.beginPath();
            
            const sliceWidth = canvas.width / dataArray.length;
            let x = 0;
            
            for (let i = 0; i < dataArray.length; i++) {
                const v = dataArray[i];
                const y = (v + 1) / 2 * canvas.height;
                
                if (i === 0) {
                    canvasCtx.moveTo(x, y);
                } else {
                    canvasCtx.lineTo(x, y);
                }
                x += sliceWidth;
            }
            
            canvasCtx.stroke();
        }

        async function connect() {
            try {
                const wsUrl = wsUrlInput.value.trim();
                log(`æ­£åœ¨è¿æ¥åˆ° ${wsUrl}...`, 'info');
                
                ws = new WebSocket(wsUrl);

                ws.onopen = () => {
                    statusDiv.innerHTML = '<span class="text-green-400">ğŸŸ¢ å·²è¿æ¥</span>';
                    log('WebSocketè¿æ¥æˆåŠŸ!', 'success');
                    connectBtn.disabled = true;
                    startBtn.disabled = false;
                    
                    // å‘é€startä¿¡å·
                    ws.send(JSON.stringify({ action: 'start' }));
                    log('å‘é€startä¿¡å·', 'info');
                };

                ws.onmessage = (event) => {
                    const receiveTime = Date.now();
                    const data = JSON.parse(event.data);
                    
                    if (data.type === 'status') {
                        log(`ä¼šè¯å°±ç»ª: ${data.session_id}`, 'success');
                        sessionInfo.textContent = `ä¼šè¯ID: ${data.session_id}`;
                    } else if (data.type === 'partial') {
                        const text = data.text || '';
                        resultDiv.innerHTML = `<span class="text-cyan-400 animate-pulse">â–¶</span> ${text}`;
                        if (data.chunk) {
                            log(`è¯†åˆ«: ${data.chunk}`, 'info');
                        }
                        document.getElementById('wordCount').textContent = text.length;
                        
                        // è®¡ç®—å»¶è¿Ÿ
                        if (window.lastSendTime) {
                            const latency = receiveTime - window.lastSendTime;
                            totalLatency += latency;
                            latencyCount++;
                            updateStats();
                        }
                    } else if (data.type === 'final') {
                        resultDiv.innerHTML = `<span class="text-green-400">âœ“</span> ${data.text}`;
                        log(`æœ€ç»ˆç»“æœ: ${data.text}`, 'success');
                        document.getElementById('wordCount').textContent = data.text.length;
                    } else if (data.type === 'error') {
                        log(`é”™è¯¯: ${data.message}`, 'error');
                        resultDiv.innerHTML = `<span class="text-red-400">âŒ é”™è¯¯: ${data.message}</span>`;
                    }
                };

                ws.onerror = (error) => {
                    log('WebSocketè¿æ¥é”™è¯¯ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦è¿è¡Œ', 'error');
                    statusDiv.innerHTML = '<span class="text-red-400">ğŸ”´ è¿æ¥é”™è¯¯</span>';
                };

                ws.onclose = () => {
                    statusDiv.innerHTML = '<span class="text-yellow-400">âšª å·²æ–­å¼€</span>';
                    log('è¿æ¥å·²å…³é—­', 'warning');
                    connectBtn.disabled = false;
                    startBtn.disabled = true;
                    stopBtn.disabled = true;
                };

            } catch (error) {
                log(`è¿æ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function startRecording() {
            try {
                log('è¯·æ±‚éº¦å…‹é£æƒé™...', 'info');
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        sampleRate: 16000,
                        channelCount: 1,
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    } 
                });

                audioContext = new AudioContext({ sampleRate: 16000 });
                const source = audioContext.createMediaStreamSource(stream);
                processor = audioContext.createScriptProcessor(9600, 1, 1);

                source.connect(processor);
                processor.connect(audioContext.destination);

                processor.onaudioprocess = (e) => {
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        const inputData = e.inputBuffer.getChannelData(0);
                        const float32Array = new Float32Array(inputData);
                        
                        // å‘é€éŸ³é¢‘æ•°æ®
                        ws.send(float32Array.buffer);
                        window.lastSendTime = Date.now();
                        chunksSent++;
                        updateStats();
                        
                        // ç»˜åˆ¶æ³¢å½¢
                        drawWaveform(inputData);
                    }
                };

                isRecording = true;
                startTime = Date.now();
                chunksSent = 0;
                totalLatency = 0;
                latencyCount = 0;
                
                startBtn.disabled = true;
                stopBtn.disabled = false;
                log('å½•éŸ³å·²å¼€å§‹ ğŸ™ï¸', 'success');
                resultDiv.innerHTML = '<span class="text-cyan-400 text-2xl animate-pulse">ğŸ¤ å½•éŸ³ä¸­...</span>';

            } catch (error) {
                log(`æ— æ³•è®¿é—®éº¦å…‹é£: ${error.message}`, 'error');
                alert('æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·ç¡®ä¿å·²æˆäºˆæƒé™å¹¶ä½¿ç”¨HTTPSè¿æ¥');
            }
        }

        function stopRecording() {
            if (processor) {
                processor.disconnect();
                processor = null;
            }

            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }

            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ action: 'stop' }));
                log('å‘é€stopä¿¡å·', 'info');
            }

            isRecording = false;
            startBtn.disabled = false;
            stopBtn.disabled = true;
            log('å½•éŸ³å·²åœæ­¢', 'warning');
            
            // æ¸…ç©ºæ³¢å½¢
            canvasCtx.fillStyle = 'rgb(17, 24, 39)';
            canvasCtx.fillRect(0, 0, canvas.width, canvas.height);
        }

        // é¡µé¢å¸è½½æ—¶æ¸…ç†
        window.addEventListener('beforeunload', () => {
            if (ws) {
                ws.close();
            }
            if (audioContext) {
                audioContext.close();
            }
        });

        // é¡µé¢åŠ è½½å®Œæˆåçš„æç¤º
        window.addEventListener('load', () => {
            log('é¡µé¢åŠ è½½å®Œæˆï¼Œè¯·ç‚¹å‡»"è¿æ¥æœåŠ¡"å¼€å§‹', 'success');
            
            // æ£€æŸ¥æ˜¯å¦ä½¿ç”¨HTTPS
            if (window.location.protocol === 'https:' && wsUrlInput.value.startsWith('ws:')) {
                log('âš ï¸ è­¦å‘Š: HTTPSé¡µé¢æ— æ³•è¿æ¥åˆ°ä¸å®‰å…¨çš„WebSocket (ws://)', 'error');
                log('è§£å†³æ–¹æ¡ˆ: 1) ä½¿ç”¨HTTPè®¿é—®æ­¤é¡µé¢ 2) é…ç½®SSLå¹¶ä½¿ç”¨wss://', 'warning');
            }
        });
    </script>
</body>
</html>